<!DOCTYPE html>
<html>
<head>
  <title>Live Voting Leaderboards</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #111;
      color: white;
      text-align: center;
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    #refresh-timer {
      font-size: 1em;
      color: #aaa;
      margin-bottom: 30px;
    }

    section {
      margin-bottom: 50px;
    }

    h2 {
      margin-top: 30px;
      font-size: 1.8em;
      text-decoration: underline;
    }

    ul {
      list-style: none;
      padding: 0;
      max-width: 600px;
      margin: auto;
    }

    li {
      margin: 12px 0;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 12px 18px;
      font-size: 0.95em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .top1 { font-size: 1.2em; font-weight: bold; background: #2a2100; color: gold; }
    .top2 { font-size: 1.1em; font-weight: bold; background: #222226; color: silver; }
    .top3 { font-size: 1.05em; font-weight: bold; background: #2b1f1a; color: #cd7f32; }
    .loading { font-size: 0.9em; color: gray; font-style: italic; background: none; box-shadow: none; }

    .name { flex: 1; text-align: left; }
    .votes { font-weight: bold; }
  </style>
</head>
<body>
  <h1>üèÜ Live Voting Results</h1>
  <div id="refresh-timer">Refreshing in 60 seconds...</div>

  <section>
    <h2>Troller of the Week</h2>
    <ul id="troller-leaderboard"><li class="loading">Loading...</li></ul>
  </section>

  <section>
    <h2>Member of the Week</h2>
    <ul id="member-leaderboard"><li class="loading">Loading...</li></ul>
  </section>

  <section>
    <h2>Staff of the Week</h2>
    <ul id="staff-leaderboard"><li class="loading">Loading...</li></ul>
  </section>

  <script>
    const csvURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSykjYD6Qo9axe3grL9wnnkZ5oMm05tFVJMorlY2csJh5-cJFSqd2c2cW064lEle11t9TayDrJsRM-n/pub?output=csv';
    const refreshSeconds = 60;
    let countdown = refreshSeconds;

    async function fetchVotes() {
      try {
        const res = await fetch(csvURL);
        const text = await res.text();
        const rows = text.trim().split('\n').slice(1); // skip headers

        const columns = {
          staff: {},
          member: {},
          troller: {}
        };

        rows.forEach(row => {
          const cols = row.split(',');
          const staff = cols[1]?.trim();
          const member = cols[2]?.trim();
          const troller = cols[3]?.trim();

          if (staff) columns.staff[staff] = (columns.staff[staff] || 0) + 1;
          if (member) columns.member[member] = (columns.member[member] || 0) + 1;
          if (troller) columns.troller[troller] = (columns.troller[troller] || 0) + 1;
        });

        const display = (data, elementId, max) => {
          const sorted = Object.entries(data)
            .sort((a, b) => b[1] - a[1])
            .slice(0, max);

          const html = sorted.map(([name, count], i) => {
            let cls = '';
            if (i === 0) cls = 'top1';
            else if (i === 1) cls = 'top2';
            else if (i === 2) cls = 'top3';

            const voteText = `${count} vote${count !== 1 ? 's' : ''}`;
            return `<li class="${cls}">
                      <span class="name">${i + 1}. <strong>${name}</strong></span>
                      <span class="votes">${voteText}</span>
                    </li>`;
          }).join('');

          document.getElementById(elementId).innerHTML = html;
        };

        display(columns.troller, 'troller-leaderboard', 5);
        display(columns.member, 'member-leaderboard', 5);
        display(columns.staff, 'staff-leaderboard', 7);
      } catch (err) {
        document.getElementById('troller-leaderboard').innerHTML = '<li class="loading">Failed to load troller votes</li>';
        document.getElementById('member-leaderboard').innerHTML = '<li class="loading">Failed to load member votes</li>';
        document.getElementById('staff-leaderboard').innerHTML = '<li class="loading">Failed to load staff votes</li>';
      }
    }

    // countdown timer
    function startTimer() {
      countdown = refreshSeconds;
      const timerEl = document.getElementById('refresh-timer');
      timerEl.textContent = `Refreshing in ${countdown} seconds...`;

      const interval = setInterval(() => {
        countdown--;
        timerEl.textContent = `Refreshing in ${countdown} seconds...`;
        if (countdown <= 0) {
          clearInterval(interval);
          fetchVotes().then(() => startTimer());
        }
      }, 1000);
    }

    fetchVotes();
    startTimer();
  </script>
</body>
</html>
