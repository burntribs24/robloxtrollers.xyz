<!DOCTYPE html>
<html>
<head>
  <title>Live Voting Leaderboards</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: #111;
      color: white;
      margin: 0;
      padding: 20px;
    }
    h1 {
      margin-bottom: 5px;
      font-weight: 700;
      font-size: 2.5em;
    }
    #refresh-timer {
      font-size: 1em;
      color: #ccc;
      margin-bottom: 30px;
    }
    section {
      margin-bottom: 50px;
    }
    h2 {
      font-size: 1.8em;
      margin-bottom: 15px;
      text-decoration: underline;
    }
    ul {
      list-style: none;
      padding: 0;
      max-width: 600px;
      margin: auto;
    }
    li {
      background: #222;
      border-radius: 12px;
      margin: 8px 0;
      padding: 10px 20px;
      font-size: 1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      transition: background-color 0.3s ease;
    }
    li.top1 {
      font-size: 1.5em;
      font-weight: 700;
      color: gold;
    }
    li.top2 {
      font-size: 1.3em;
      font-weight: 700;
      color: silver;
    }
    li.top3 {
      font-size: 1.2em;
      font-weight: 700;
      color: #cd7f32; /* bronze */
    }
    li.others {
      font-size: 1em;
      color: #ccc;
    }
    strong {
      flex: 1;
      text-align: left;
    }
    span.vote-count {
      margin-left: 15px;
      font-weight: 600;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>üèÜ Live Voting Results</h1>
  <div id="refresh-timer">Refreshing in 60 seconds...</div>

  <section>
    <h2>Troller of the Week</h2>
    <ul id="troller-leaderboard"></ul>
  </section>

  <section>
    <h2>Member of the Week</h2>
    <ul id="member-leaderboard"></ul>
  </section>

  <section>
    <h2>Staff of the Week</h2>
    <ul id="staff-leaderboard"></ul>
  </section>

  <script>
    const csvURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSykjYD6Qo9axe3grL9wnnkZ5oMm05tFVJMorlY2csJh5-cJFSqd2c2cW064lEle11t9TayDrJsRM-n/pub?output=csv';

    // CSV parser that handles quoted commas properly
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      return lines.map(line => {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current);
        return result;
      });
    }

    let refreshInterval = 60;
    let currentTime = refreshInterval;

    async function fetchVotes() {
      try {
        const res = await fetch(csvURL);
        const text = await res.text();

        const rows = parseCSV(text).slice(1); // skip header

        const columns = {
          troller: {},
          member: {},
          staff: {}
        };

        rows.forEach(cols => {
          // cols[0] is the username ‚Äî IGNORE this for votes
          const troller = cols[1]?.trim();
          const member = cols[2]?.trim();
          const staff = cols[3]?.trim();

          if (troller) columns.troller[troller] = (columns.troller[troller] || 0) + 1;
          if (member) columns.member[member] = (columns.member[member] || 0) + 1;
          if (staff) columns.staff[staff] = (columns.staff[staff] || 0) + 1;
        });

        const display = (data, elementId, max) => {
          const sorted = Object.entries(data)
            .sort((a, b) => b[1] - a[1])
            .slice(0, max);

          const html = sorted.map(([name, count], i) => {
            let cls = 'others';
            if (i === 0) cls = 'top1';
            else if (i === 1) cls = 'top2';
            else if (i === 2) cls = 'top3';

            const voteText = count === 1 ? 'vote' : 'votes';

            return `<li class="${cls}"><strong>${i + 1}. ${name}</strong><span class="vote-count">(${count} ${voteText})</span></li>`;
          }).join('');
          document.getElementById(elementId).innerHTML = html;
        };

        display(columns.troller, 'troller-leaderboard', 5);
        display(columns.member, 'member-leaderboard', 5);
        display(columns.staff, 'staff-leaderboard', 7);

      } catch (error) {
        console.error('Failed to fetch votes:', error);
      }
    }

    function startCountdown() {
      const timerEl = document.getElementById('refresh-timer');
      timerEl.textContent = `Refreshing in ${currentTime} seconds...`;
      const countdown = setInterval(() => {
        currentTime--;
        if (currentTime <= 0) {
          fetchVotes();
          currentTime = refreshInterval;
        }
        timerEl.textContent = `Refreshing in ${currentTime} seconds...`;
      }, 1000);
    }

    fetchVotes();
    startCountdown();
  </script>
</body>
</html>
