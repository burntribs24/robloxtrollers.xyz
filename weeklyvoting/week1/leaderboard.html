<!DOCTYPE html>
<html>
<head>
  <title>Live Voting Leaderboards</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: #111;
      color: white;
      margin: 20px;
    }
    section {
      margin-bottom: 50px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    h2 {
      margin-top: 30px;
      font-size: 2em;
      text-decoration: underline;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin: 10px 0;
      background: #222;
      border-radius: 10px;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.1em;
    }
    .top1 {
      font-size: 1.8em;
      font-weight: bold;
      color: gold;
    }
    .top2 {
      font-size: 1.5em;
      font-weight: bold;
      color: silver;
    }
    .top3 {
      font-size: 1.3em;
      font-weight: bold;
      color: #cd7f32; /* bronze */
    }
    .others {
      font-size: 1em;
      color: #ccc;
    }
    #refresh-timer {
      font-size: 1em;
      margin-bottom: 20px;
      color: #bbb;
    }
  </style>
</head>
<body>
  <h1>üèÜ Live Voting Results</h1>
  <div id="refresh-timer">Refreshing in 60 seconds</div>

  <section>
    <h2>Troller of the Week</h2>
    <ul id="troller-leaderboard"></ul>
  </section>

  <section>
    <h2>Member of the Week</h2>
    <ul id="member-leaderboard"></ul>
  </section>

  <section>
    <h2>Staff of the Week</h2>
    <ul id="staff-leaderboard"></ul>
  </section>

  <script>
    const csvURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSykjYD6Qo9axe3grL9wnnkZ5oMm05tFVJMorlY2csJh5-cJFSqd2c2cW064lEle11t9TayDrJsRM-n/pub?output=csv';

    const refreshInterval = 60; // seconds
    let timer = refreshInterval;

    async function fetchVotes() {
      const res = await fetch(csvURL);
      const text = await res.text();
      const rows = text.trim().split('\n').slice(1); // skip header

      const columns = {
        troller: {},
        member: {},
        staff: {}
      };

      rows.forEach(row => {
        const cols = row.split(',');

        // Ignore first column (timestamp) and first question column (username input)
        // Columns: 0 - timestamp, 1 - username input, 2 - Troller, 3 - Member, 4 - Staff
        const troller = cols[2]?.trim();
        const member = cols[3]?.trim();
        const staff = cols[4]?.trim();

        if (troller) columns.troller[troller] = (columns.troller[troller] || 0) + 1;
        if (member) columns.member[member] = (columns.member[member] || 0) + 1;
        if (staff) columns.staff[staff] = (columns.staff[staff] || 0) + 1;
      });

      const display = (data, elementId, max) => {
        const sorted = Object.entries(data)
          .sort((a, b) => b[1] - a[1])
          .slice(0, max);

        const html = sorted.map(([name, count], i) => {
          let cls = 'others';
          if (i === 0) cls = 'top1';
          else if (i === 1) cls = 'top2';
          else if (i === 2) cls = 'top3';

          return `<li class="${cls}">
            <span>${i + 1}. <strong>${name}</strong></span>
            <span>${count} vote${count === 1 ? '' : 's'}</span>
          </li>`;
        }).join('');
        document.getElementById(elementId).innerHTML = html;
      };

      display(columns.troller, 'troller-leaderboard', 5);
      display(columns.member, 'member-leaderboard', 5);
      display(columns.staff, 'staff-leaderboard', 7);

      timer = refreshInterval; // reset timer after fetching
    }

    function updateTimer() {
      const timerDiv = document.getElementById('refresh-timer');
      timerDiv.textContent = `Refreshing in ${timer} second${timer === 1 ? '' : 's'}`;
      timer--;
      if (timer < 0) timer = 0;
    }

    fetchVotes();
    setInterval(fetchVotes, refreshInterval * 1000);
    setInterval(updateTimer, 1000);
  </script>
</body>
</html>
